<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="jHitSphere" />
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
  TeX: {
    TagSide: "left",
    Macros: {
      T: '^{\\mathrm T}',
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>
    <script type="text/javascript"
     src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>


    <title>jHitSphere</title>
  </head>

<body>

<a href="index.html">Go back to main page</a>

<h1> Overview </h1>

<p>The jHitSphere function checks if a ray of light is blocked by a sphere in 3-D space.</p>

<p>This function is used by the game engine to check if bullets hit objects, and to check if a star's light is blocked by a planet.</p>

<p>I have been forgotten the rationale and had hard time remembering the linear algebra, so I record the process for later reference.</p>

<h1> Rationale </h1>

<p>The function resolves intersecting points of a line and a sphere using vector arithmetic.</p>

<p>Suppose we represent a line in space by vector equation:</p>

$$\vec{r}=\vec{a}+t\vec{d}$$

<p>and a sphere:</p>

$$|\vec{r}-\vec{b}|=R$$

<p>The intersecting points are obtained by forming a system of equations.</p>

$$|\vec{a}+t\vec{d}-\vec{b}|=R$$

<p>The relative position can be assumed as a constant vector $\vec{r_0}=\vec{a}-\vec{b}$ and the equation becomes:</p>

$$|\vec{r_0}+t\vec{d}|=R$$

<p>Expanding the absolute value term yields following equation.</p>

$$|\vec{r_0}|^2+2t\vec{r_0}\cdot\vec{d}+t^2|\vec{d}|^2=R^2$$

<p>Solving the 2nd order equation about $t$ yields the following answer.</p>

$$t=\frac{-\vec{r_0}\cdot\vec{d}\pm\sqrt{(\vec{r_0}\cdot\vec{d})^2-|\vec{d}|^2(|\vec{r_0}|^2-R^2)}}{|\vec{d}|^2}$$

<p>This two $t$ values are the vector equation parameters of the intersecting points.</p>

<p>Examining sign of the discriminant of the equation</p>

$$D=(\vec{r_0}\cdot\vec{d})^2-|\vec{d}|^2(|\vec{r_0}|^2-R^2)$$

<p>tells us if the intersection occurs at all.</p>

<p>This result leads us to the implementation.</p>

<pre><code>
bool jHitSphere(const Vec3d &obj, double radius, const Vec3d &src, const Vec3d &dir, double dt){
	double b, c, D, d, t0, t1, dirslen;
	bool ret;

	Vec3d del = src - obj;

	/* scalar product of the ray and the vector. */
	b = dir.sp(del);

	dirslen = dir.slen();
	c = dirslen * (del.slen() - radius * radius);

	/* Discriminant */
	D = b * b - c;
	if(D <= 0)
		return false;

	d = sqrt(D);

	/* Avoid zerodiv */
	if(dirslen == 0.)
		return false;
	t0 = (-b - d) / dirslen;
	t1 = (-b + d) / dirslen;

	return 0. <= t1 && t0 < dt;
}
</code></pre>

<p>All other codes in actual source are options or implementation details. The core of the logic is all shown above.<p>

<p>Also, you can retrieve the position closest to the sphere's center by using average of the intersecting points,<p>

$$t_m=-\frac{\vec{r_0}\cdot\vec{d}}{|\vec{d}|^2}$$

<p>even if the solution is imaginary.<p>


<hr>

<p>
<a href="jHitSphere-ja.html">日本語</a>
</p>



</body>
</html>
