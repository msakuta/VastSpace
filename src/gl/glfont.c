#include "clib/gl/gldraw.h"
#include <stdio.h>
#include <string.h>
#include <stdarg.h>

static const unsigned char font8x10[] = {
255,255,255,255,255,255,255,255,255,255,255,255,247,255,255,255,
239,253,255,255,255,255,255,255,255,227,255,255,247,255,255,201,
239,253,239,227,251,241,247,235,221,253,225,251,247,247,255,219,
227,241,239,253,247,237,235,213,235,241,247,247,247,251,255,203,
237,237,239,243,247,237,237,213,247,237,251,247,247,251,239,219,
229,233,231,239,247,237,237,221,211,237,253,239,247,253,213,139,
235,245,233,243,227,237,222,255,237,237,225,247,247,251,251,175,
255,255,255,255,247,255,255,255,255,255,255,247,247,251,255,175,
255,255,255,255,247,255,255,255,255,255,255,251,247,247,255,159,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,227,255,255,207,255,255,255,255,255,
255,241,227,241,241,241,247,237,237,247,247,237,247,213,237,243,
255,237,237,239,237,239,247,241,237,247,247,235,247,213,237,237,
255,241,237,239,237,225,247,225,237,247,247,231,247,213,237,237,
255,253,237,239,237,237,225,237,227,247,247,235,247,213,237,237,
251,227,227,241,241,243,247,237,239,247,247,237,247,203,227,243,
247,255,239,255,253,255,247,241,239,255,255,239,247,255,255,255,
247,255,239,255,253,255,249,254,239,247,247,239,247,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
239,244,237,227,247,243,247,235,221,247,193,227,254,227,255,128,
239,233,237,253,247,237,235,213,221,247,223,239,253,251,255,255,
239,233,237,253,247,237,221,213,235,247,239,239,251,251,255,255,
227,237,227,243,247,237,221,213,247,247,247,239,247,251,255,255,
237,237,237,239,247,237,221,221,235,235,251,239,239,251,255,255,
237,237,237,239,247,237,221,221,221,221,253,239,223,251,221,255,
227,243,227,241,193,237,221,221,221,221,193,227,191,227,235,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,247,255,
227,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
221,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
160,237,227,243,231,225,239,243,237,227,231,237,225,221,237,243,
170,237,237,237,235,239,239,237,237,247,251,237,239,221,237,237,
162,225,237,237,237,239,239,237,237,247,251,235,239,221,233,237,
186,237,227,239,237,225,227,233,225,247,251,231,239,213,233,237,
166,245,237,239,237,239,239,239,237,247,251,235,239,213,229,237,
221,245,237,237,235,239,239,239,237,247,251,237,239,201,229,237,
227,249,227,243,231,225,225,243,237,227,225,237,239,221,237,243,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,239,255,255,255,255,
227,227,193,227,247,227,227,247,227,227,255,247,253,255,223,247,
221,247,223,221,247,221,221,247,221,253,247,247,243,193,231,255,
205,247,223,253,131,253,221,251,221,253,255,255,239,255,251,247,
213,247,225,227,183,195,195,251,227,225,255,255,223,255,253,247,
217,247,253,253,215,223,223,221,221,221,255,255,239,193,251,251,
221,231,221,221,231,223,223,221,221,221,247,247,243,255,231,221,
227,247,227,227,247,195,227,193,227,227,255,255,253,255,223,221,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,227,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,247,255,255,247,219,229,255,251,247,247,255,239,255,255,191,
255,255,255,235,227,213,219,255,247,251,213,247,247,255,243,223,
255,247,255,193,213,235,213,255,239,253,213,247,247,255,243,239,
255,247,255,235,243,247,231,255,239,253,227,193,255,193,255,247,
255,247,255,235,231,235,219,255,239,253,213,247,255,255,255,251,
255,247,235,193,213,213,219,247,239,253,213,247,255,255,255,253,
255,247,235,235,227,237,231,247,247,251,247,255,255,255,255,254,
255,255,255,255,247,255,255,255,251,247,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,
255,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
209,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
213,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
209,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
215,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
209,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
255,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
255,190,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,
255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,
255,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
137,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
171,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
171,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
255,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
179,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
171,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
155,128,190,190,190,190,190,190,190,190,190,190,190,190,190,190,
};
static int bitmapfontinit = 0;
static unsigned char bitmapfont[256][10];

static void bitmapfont_build(){
	int n;
	if(bitmapfontinit)
		return;
	bitmapfontinit = 1;
	for(n = 0; n < 128; n++){
		int i;
		for(i = 0; i < 10; i++)
			bitmapfont[n][i] = ~font8x10[n % 16 + ((7 - n / 16) * 10 + i) * 16];
	}
}

void gldPutString(const char *s){
#if 0
	static int init = 0;
	static GLuint fonttex = 0;
	GLuint oldtex;
	glGetIntegerv(GL_TEXTURE_2D, &oldtex);
	if(!init){
		int y, x;
		GLubyte buf[80][128];
		init = 1;
		glGenTextures(1, &fonttex);
		glBindTexture(GL_TEXTURE_2D, fonttex);
		for(y = 0; y < 80; y++) for(x = 0; x < 128; x++){
			buf[y][x] = 0x1 & (font8x10[y * 16 + x / 8] >> (7 - (x) % 8)) ? 255 : 0;
		}
		glTexImage2D(GL_TEXTURE_2D, 0, GL_ALPHA, 128, 128, 0, GL_ALPHA, GL_BYTE, buf);
	}
	glBindTexture(GL_TEXTURE_2D, fonttex);
	glBindTexture(GL_TEXTURE_2D, oldtex);
#else
	glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
	bitmapfont_build();
	while(*s){
		glBitmap(8, 10, 0, 0, 8, 0, bitmapfont[*s]);
		s++;
/*		glutBitmapCharacter(GLUT_BITMAP_8_BY_13, *s++);*/
	}
#endif
}

void gldPutStringN(const char *s, int n){
	int i = 0;
	glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
	bitmapfont_build();
	while(*s && i++ < n){
		int j;
		unsigned char buf[10];
		for(j = 0; j < 10; j++)
			buf[j] = ~font8x10[*s % 16 + ((7 - *s / 16) * 10 + j) * 16];
		glBitmap(8, 10, 0, 0, 8, 0, buf);
		s++;
/*		glutBitmapCharacter(GLUT_BITMAP_8_BY_13, *s++);*/
	}
}

void gldPutStrokeString(const char *s){
/*	gldPutStrokeStringN(s, strlen(s));*/
}

void gldPutStrokeStringN(const char *s, int n){
/*	int i = 0;
	glPushMatrix();
	glScaled(1. / 104.76, 1. / 104.76, 1.);
	while(*s && i++ < n)
		glutStrokeCharacter(GLUT_STROKE_MONO_ROMAN, *s++);
	glPopMatrix();
	glTranslatef(n, 0.f, 0.f);*/
}


#define GLDTW 128
#define GLDTH 80

void gldPutTextureStringN(const char *s, int n){
	static int init = 0;
	static GLuint fonttex = 0;
	GLuint oldtex;
	int i;
	glGetIntegerv(GL_TEXTURE_2D, &oldtex);
	if(!init){
		int y, x;
		GLubyte buf[GLDTW][GLDTW][2];
		init = 1;
		glGenTextures(1, &fonttex);
		glBindTexture(GL_TEXTURE_2D, fonttex);
		for(y = 0; y < GLDTW - GLDTH; y++) for(x = 0; x < GLDTW; x++){
			buf[y][x][0] = buf[y][x][1] = 127;
		}
		for(y = 0; y < GLDTH; y++) for(x = 0; x < GLDTW; x++){
			buf[y + GLDTW - GLDTH][x][0] = 255; buf[y + GLDTW - GLDTH][x][1] = (0x1 & (font8x10[y * 16 + x / 8] >> (7 - (x) % 8)) ? 0 : 255);
		}
		glTexImage2D(GL_TEXTURE_2D, 0, 2, GLDTW, GLDTW, 0, GL_LUMINANCE_ALPHA, GL_UNSIGNED_BYTE, buf);
	}
	glBindTexture(GL_TEXTURE_2D, fonttex);
	glPushMatrix();
	glPushAttrib(GL_TEXTURE_BIT);
	glEnable(GL_TEXTURE_2D);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR/*/GL_NEAREST*/);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR/*/GL_NEAREST*/);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
	glTexEnvf(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_MODULATE);
	{
		GLfloat envc[4] = {0,0,0,0};
		glTexEnvfv(GL_TEXTURE_ENV, GL_TEXTURE_ENV_COLOR, envc);
	}
	glBegin(GL_QUADS);
	for(i = 0; *s && i < n; i++){
		glTexCoord2d(*s % 16 * 8. / GLDTW, (12 - *s / 16 - .1) * 10. / GLDTW); glVertex2i(i,0);
		glTexCoord2d((*s % 16 + 1) * 8. / GLDTW, (12 - *s / 16 - .1) * 10. / GLDTW); glVertex2i(i+1,0);
		glTexCoord2d((*s % 16 + 1) * 8. / GLDTW, (12 - *s / 16 + .7) * 10. / GLDTW); glVertex2i(i+1,1);
		glTexCoord2d(*s % 16 * 8. / GLDTW, (12 - *s / 16 + .7) * 10. / GLDTW); glVertex2i(i,1);
		s++;
	}
	glEnd();
/*	glLoadIdentity();
	glBegin(GL_QUADS);
		glTexCoord2d(0, 0); glVertex2i(0,0);
		glTexCoord2d(1, 0); glVertex2i(+1,0);
		glTexCoord2d(1, 1); glVertex2i(+1,1);
		glTexCoord2d(0, 1); glVertex2i(0,1);
	glEnd();*/
	glPopAttrib();
	glPopMatrix();
	glTranslatef(n, 0.f, 0.f);
	glBindTexture(GL_TEXTURE_2D, oldtex);
}

void gldPutTextureString(const char *s){
	gldPutTextureStringN(s, strlen(s));
}

int gld_align = 0;

void gldprintf(const char *f, ...){
	static char buf[512]; /* it's not safe but unlikely to be reached */
	va_list ap;
	va_start(ap, f);

	/* Unluckily, snprintf is not part of the standard. */
#ifdef _WIN32
	_vsnprintf(buf, sizeof buf, f, ap);
#else
	vsprintf(buf, f, ap);
#endif

	gldPutString(buf);
	va_end(ap);
}

