<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="jHitSphere" />
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
  TeX: {
    TagSide: "left",
    Macros: {
      T: '^{\\mathrm T}',
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>
    <script type="text/javascript"
     src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>


    <title>jHitSphere</title>
  </head>

<body>

<a href="index.html">Go back to main page</a>

<h1> 概要 </h1>

<p>jHitSphere という関数は3次元空間で光線と球体の衝突を判定します。</p>

<p>ゲームエンジン内で弾丸と物体の当たり判定や、恒星の光が惑星によって遮られるかの判定などに使われています。</p>

<p>原理を忘れて線形代数を思い出すのに時間がかかったので、後での参照用に記録しておきます。</p>

<h1> 原理 </h1>

<p>この関数はベクトル演算を使って直線と球体の共有点を見つけます。</p>

<p>直線が次のベクトル方程式で表されたとしましょう：</p>

$$\vec{r}=\vec{a}+t\vec{d}$$

<p>そして球体も：</p>

$$|\vec{r}-\vec{b}|=R$$

<p>共有点は方程式を連立することで求まります。</p>

$$|\vec{a}+t\vec{d}-\vec{b}|=R$$

<p>相対的な位置を定ベクトル $\vec{r_0}=\vec{a}-\vec{b}$ と見なすと方程式は次のようになります：</p>

$$|\vec{r_0}+t\vec{d}|=R$$

<p>絶対値の項を展開すると次の式になります。</p>

$$|\vec{r_0}|^2+2t\vec{r_0}\cdot\vec{d}+t^2|\vec{d}|^2=R^2$$

<p>tについて2次方程式を解くと次の答えが出ます。</p>

$$t=\frac{-\vec{r_0}\cdot\vec{d}\pm\sqrt{(\vec{r_0}\cdot\vec{d})^2-|\vec{d}|^2(|\vec{r_0}|^2-R^2)}}{|\vec{d}|^2}$$

<p>この $t$ の2つの値は、共有点を示すベクトル方程式のパラメータです。</p>

<p>判別式</p>

$$D=(\vec{r_0}\cdot\vec{d})^2-|\vec{d}|^2(|\vec{r_0}|^2-R^2)$$

<p>の符号を調べることで、共有点があるかどうかを知ることができます。</p>

<p>この結果から実装が次のようになるわけです。</p>

<pre><code>
bool jHitSphere(const Vec3d &obj, double radius, const Vec3d &src, const Vec3d &dir, double dt){
	double b, c, D, d, t0, t1, dirslen;
	bool ret;

	Vec3d del = src - obj;

	/* scalar product of the ray and the vector. */
	b = dir.sp(del);

	dirslen = dir.slen();
	c = dirslen * (del.slen() - radius * radius);

	/* Discriminant */
	D = b * b - c;
	if(D <= 0)
		return false;

	d = sqrt(D);

	/* Avoid zerodiv */
	if(dirslen == 0.)
		return false;
	t0 = (-b - d) / dirslen;
	t1 = (-b + d) / dirslen;

	return 0. <= t1 && t0 < dt;
}
</pre></code>

<p>実際のコード中のいろいろな処理はオプションだとか細かい話で、論理の核心は上に示されているので全てです。

<p>なお、虚数解であろうとも、直線と球の中心との最近点は共有点の中点をとることでわかります。

$$t_m=-\frac{\vec{r_0}\cdot\vec{d}}{|\vec{d}|^2}$$




<hr>

<p>
<a href="jHitSphere.html">English</a>
</p>



</body>
</html>
