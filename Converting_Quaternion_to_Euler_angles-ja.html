<html>
  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="jHitSphere" />
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
  TeX: {
    TagSide: "left",
    Macros: {
      T: '^{\\mathrm T}',
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>
    <script type="text/javascript"
     src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>


    <title>jHitSphere</title>
  </head>

<body>

<a href="index.html">Go back to main page</a>

<h1> 概要 </h1>

この記事では四元数をオイラー角へ変換する方法を論じます。
この数学はトリビアルではなく、記録しておかないと忘れそうです。

<h1> 理論 </h1>

<p>四元数 $\mathbf{q}$ が要素 $q_i$ を持ち、3次元の回転を表しているとしましょう。
この四元数は複素数に似た形で表せます。
</p>

$$\mathbf{q} = q_0 + q_1 \mathbf{i} + q_2 \mathbf{j} + q_3 \mathbf{k}$$

<p>回転を表すほかの形式としては、オイラー角 $(\phi, \theta, \psi)$ があります。
オイラー角は航空力学の分野ではピッチ、ヨー、ロールと呼ばれることが多いです。
</p>

<p>単位四元数とオイラー角は等価です。
オイラー角から四元数へは、各軸の回転を表す四元数を作って積をとることで変換できますが、逆はそれほど自明ではありません。
</p>

<p>問題は、オイラー角の定義の仕方が複数存在するため、インターネット上のそこらのソースをコピペしても使えないということです。
その代わりに、我々は変換の内容を本質的に理解しなければなりません。
ただし、我々の目的に似たような記事が一つありました：
</p>

<p><a href="http://graphics.wikia.com/wiki/Conversion_between_quaternions_and_Euler_angles">
http://graphics.wikia.com/wiki/Conversion_between_quaternions_and_Euler_angles
</a></p>

<p>残念ながら、この記事の座標系の定義は我々のものと異なります。
</p>

<p>我々のケースでは、Z軸が'''後ろ'''を指し、X軸が右を指し、Y軸が上を指します。
この規約は、機体から見たときデカルト座標系に見えるのと、我々（およびOpenGL）が右手系を好んでいるために選ばれました。
</p>

<p>したがって、我々の定義では</p>

<ul>
<li> ロール - $\phi$: Z軸周りの回転
<li> ピッチ - $\theta$: X軸周りの回転
<li> ヨー - $\psi$: Y軸周りの回転
</ul>

<p>回転の順番は参考文献と同じです。つまりヨー、ピッチ、ロールの順です。</p>

<p>各軸の周りの回転は次のように定義されます。</p>

$$ \mathbf{q_\phi} = \cos(\phi/2) + \sin(\phi/2) \mathbf{k} $$
$$ \mathbf{q_\theta} = \cos(\theta/2) + \sin(\theta/2) \mathbf{i} $$
$$ \mathbf{q_\psi} = \cos(\psi/2) + \sin(\psi/2) \mathbf{j} $$


<h2> 回転行列 </h2>
回転を表す四元数 $\mathbf{q}$ は、参考文献と同じく次のように得られます。
$$ \begin{bmatrix}
 1- 2(q_2^2 + q_3^2) &  2(q_1 q_2 - q_0 q_3) &  2(q_0 q_2 + q_1 q_3) \\
2(q_1 q_2 + q_0 q_3) & 1 - 2(q_1^2 + q_3^2)  &  2(q_2 q_3 - q_0 q_1) \\
2(q_1 q_3 - q_0 q_2) & 2( q_0 q_1 + q_2 q_3) &  1 - 2(q_1^2 + q_2^2)
\end{bmatrix} $$

オイラー角 $(\phi, \theta, \psi)$ のそれぞれの回転は

$$ \mathbf{R}_\phi =
\begin{bmatrix}
\cos\phi & -\sin\phi & 0 \\
\sin\phi &  \cos\phi & 0 \\
0        &  0        & 1 \\
\end{bmatrix} $$

$$ \mathbf{R}_\theta =
\begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\theta & -\sin\theta \\
0 & \sin\theta &  \cos\theta \\
\end{bmatrix} $$

$$ \mathbf{R}_\psi =
\begin{bmatrix}
 \cos\psi & 0 & \sin\psi \\
 0        & 1 & 0        \\
-\sin\psi & 0 & \cos\psi \\
\end{bmatrix} $$

この3行列の積をとると

$$ \mathbf{R}_\psi \mathbf{R}_\theta \mathbf{R}_\phi =
\begin{bmatrix}
\cos\phi \cos\psi - \sin\phi \cos\theta \sin\psi & -\sin\phi \cos\theta & \cos\phi \sin\psi + \sin\phi \sin\theta \cos\psi \\
\sin\phi \cos\psi + \cos\phi \sin\theta \sin\phi &  \cos\phi \cos\theta & \sin\phi \sin\psi - \cos\phi \sin\theta \cos\psi \\
-\cos\theta \sin\psi & \sin\theta & \cos\theta \cos\psi \\
\end{bmatrix}
$$

$\mathbf{q}$ と $\mathbf{R}_\psi \mathbf{R}_\theta \mathbf{R}_\phi$ は等しくなければならないので、行列の要素を比較して次を得ます。

$$
\theta = \sin^{-1} \{2(q_0 q_1 + q_2 q_3)\} \\
\phi = \tan^{-1} \left\{ -\frac{2(q_1 q_2 - q_0 q_3)}{1 - 2({q_1}^2 + {q_3}^2)} \right\} \\
\psi = \tan^{-1} \left\{ -\frac{2(q_1 q_3 - q_0 q_2)}{1 - 2({q_1}^2 + {q_2}^2)} \right\}
$$


<hr>

<p>
<a href="Converting_Quaternion_to_Euler_angles.html">English</a>
</p>


</body>
</html>
